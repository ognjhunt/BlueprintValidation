schema_version: v1
project_name: "WM-Only Strict Fresh (Data Quality Recovery)"

facilities:
  kitchen_0787:
    name: "Kitchen Scene 0787 (InteriorGS)"
    ply_path: /app/data/interiorgs/0787_841244/3dgs_compressed.ply
    task_hints_path: /app/data/interiorgs/0787_841244/task_targets.synthetic.json
    description: >
      Compact apartment interior with kitchen nook. Contains dishwasher,
      fridge, kettle, microwave, oven, and rice cooker.
    landmarks:
      - "kitchen appliances and countertop"
      - "dining table with glassware"
      - "cabinet and cupboard storage area"
    video_orientation_fix: rotate180
    up_axis: "z"
    floor_height_m: 0.0
    ceiling_height_m: 2.8

render:
  resolution: [480, 640]
  fps: 10
  num_frames: 73
  camera_height_m: 1.0
  camera_look_down_deg: 20
  camera_paths:
    - type: orbit
      radius_m: 2.5
      num_orbits: 2
    - type: sweep
      length_m: 5.0
    - type: manipulation
      height_override_m: 0.5
      look_down_override_deg: 40
  num_clips_per_path: 3
  scene_aware: true
  task_scoped_scene_aware: true
  task_scoped_max_specs: 60
  task_scoped_context_per_target: 2
  task_scoped_overview_specs: 6
  task_scoped_fallback_specs: 16
  task_scoped_profile: dreamdojo
  task_scoped_num_clips_per_path: 2
  task_scoped_num_frames_override: 97
  collision_check: true
  voxel_size_m: 0.08
  density_threshold: 3
  min_clearance_m: 0.12
  vlm_fallback: true
  vlm_fallback_model: gemini-3-flash-preview
  vlm_fallback_num_views: 4
  stage1_coverage_gate_enabled: true
  stage1_coverage_min_visible_frame_ratio: 0.35
  stage1_coverage_min_approach_angle_bins: 2
  stage1_coverage_angle_bin_deg: 45
  stage1_coverage_blur_laplacian_min: 20.0
  stage1_coverage_blur_sample_every_n_frames: 5
  stage1_coverage_blur_max_samples_per_clip: 12
  stage1_coverage_min_center_band_ratio: 0.40
  stage1_coverage_center_band_x: [0.20, 0.80]
  stage1_coverage_center_band_y: [0.20, 0.80]

robot_composite:
  enabled: false

gemini_polish:
  enabled: false

robosplat:
  enabled: true
  backend: auto
  parity_mode: hybrid
  runtime_preset: balanced
  variants_per_input: 4
  object_source_priority: [task_hints_obb, vlm_detect, cluster]
  demo_source: synthetic
  bootstrap_if_missing_demo: true
  bootstrap_num_rollouts: 6
  bootstrap_horizon_steps: 24
  bootstrap_tasks_limit: 4
  quality_gate_enabled: true
  min_variants_required_per_clip: 1
  fallback_to_legacy_scan: true
  fallback_on_backend_error: true
  persist_scene_variants: false
  vendor_repo_path: ../vendor/robosplat

enrich:
  cosmos_model: nvidia/Cosmos-Transfer2.5-2B
  cosmos_checkpoint: /models/checkpoints/cosmos-transfer-2.5-2b/
  cosmos_repo: /app/data/vendor/cosmos-transfer
  controlnet_inputs: [rgb, depth]
  num_variants_per_render: 2
  guidance: 5.0
  dynamic_variants: false
  allow_dynamic_variant_fallback: false
  context_frame_index: 9
  context_frame_mode: target_centered
  max_input_frames: 0
  cosmos_output_quality: 8
  min_frame0_ssim: 0.70
  delete_rejected_outputs: true
  # Debug-only task-targeted one-clip mode (opt-in; keep defaults above for full enrichment):
  # max_source_clips: 1
  # source_clip_selection_mode: task_targeted
  # source_clip_task: "Pick up trash_can_157 and place it in the target zone"

finetune:
  dreamdojo_repo: /app/data/vendor/DreamDojo
  dreamdojo_checkpoint: /models/checkpoints/DreamDojo/2B_pretrain/
  experiment_config: 2b_480_640_gr1
  eval_world_experiment: cosmos_predict2p5_2B_action_conditioned_gr00t_gr1_customized_13frame
  video_dataset_backend: opencv
  probe_dataloader_sample: true
  model_size: 2B
  use_lora: true
  lora_rank: 32
  lora_alpha: 32
  lora_target_modules: "q_proj,k_proj,v_proj,output_proj,mlp.layer1,mlp.layer2"
  learning_rate: 1.0e-4
  num_epochs: 50
  batch_size: 1
  gradient_accumulation_steps: 4
  warmup_steps: 100
  save_every_n_epochs: 10
  max_training_hours: 24

eval_policy:
  model_name: openvla/openvla-7b
  checkpoint_path: /models/checkpoints/openvla-7b/
  unnorm_key: bridge_orig
  headline_scope: wm_only
  rollout_driver: scripted
  scripted_rollouts_per_task: 12
  mode: claim
  num_rollouts: 100
  max_steps_per_rollout: 100
  conditions: ["baseline", "adapted"]
  min_absolute_difference: 1.0
  min_manip_success_delta_pp: 15.0
  reliability:
    max_horizon_steps: 12
    keyframe_reanchor_every: 4
    min_replay_pass_rate: 0.70
    min_controllability_pass_rate: 0.70
    enforce_stage_success: true
    max_scoring_failure_rate: 0.02
  tasks:
    - "Navigate to the kitchen counter area"
    - "Approach the refrigerator"
    - "Move toward the dining table"
  manipulation_tasks:
    - "Pick up the bowl from the counter and place it in the sink"
    - "Open the dishwasher door and load a dish"
    - "Pick up the kettle and move it to the stove"
    - "Open the oven door and place the dish inside"
    - "Pick up the cup and place it on the shelf"
    - "Open the refrigerator and retrieve an item"
  vlm_judge:
    model: gemini-3-flash-preview
    api_key_env: GOOGLE_GENAI_API_KEY
    enable_agentic_vision: true

# Full action-success boost mode (scan-only, no new real data).
# Keeps wm_only in config but runtime auto-switches to dual when enabled.
action_boost:
  enabled: false
  require_full_pipeline: false
  auto_switch_headline_scope_to_dual: false
  auto_enable_rollout_dataset: false
  auto_enable_policy_finetune: false
  auto_enable_policy_rl_loop: false
  compute_profile: standard
  strict_disjoint_eval: false

wm_refresh_loop:
  enabled: true
  iterations: 1
  source_condition: adapted
  fail_if_refresh_fails: true
  fail_on_degenerate_mix: true
  min_non_hard_rollouts: 8
  quantile_fallback_enabled: true
  quantile_success_threshold: 0.85
  quantile_near_miss_threshold: 0.50

policy_finetune:
  enabled: false

policy_rl_loop:
  enabled: false
  policy_refine_near_miss_fraction: 0.30
  policy_refine_hard_negative_fraction: 0.10
  world_model_refresh_mix_with_stage2: true
  world_model_refresh_stage2_fraction: 0.60
  world_model_refresh_success_fraction: 0.25
  world_model_refresh_near_miss_fraction: 0.15
  world_model_refresh_min_total_clips: 128
  world_model_refresh_max_total_clips: 512
  world_model_refresh_seed: 17

rollout_dataset:
  enabled: false
  selection_mode: success_near_miss
  near_miss_min_task_score: 5.0
  near_miss_max_task_score: 6.99
  near_miss_target_fraction: 0.30
  hard_negative_target_fraction: 0.00

policy_compare:
  enabled: false

eval_visual:
  metrics: [psnr, ssim, lpips]
  lpips_backbone: alex

eval_spatial:
  num_sample_frames: 20
  vlm_model: gemini-3-flash-preview
  min_valid_samples: 3
  fail_on_reasoning_conflict: true

eval_crosssite:
  num_clips_per_model: 30
  vlm_model: gemini-3-flash-preview

cloud:
  provider: generic
  gpu_type: H100
  num_gpus: 2
  # 60 total H100-hours at $4/hour effective burn-rate.
  max_cost_usd: 240
  auto_shutdown: false
