name: Docker Publish
# trigger-note: workflow trigger refresh

on:
  push:
    branches: [main]
    paths:
      - "docker/**"
      - "src/**"
      - "scripts/**"
      - "pyproject.toml"
      - "uv.lock"
      - ".github/workflows/docker-publish.yaml"
  workflow_dispatch:
    inputs:
      image:
        description: "Docker image repo (e.g. nijelhunt/blueprint-validation)"
        required: false
        default: "nijelhunt/blueprint-validation"
      dockerfile:
        description: "Dockerfile path"
        required: false
        default: "docker/runpod.Dockerfile"
      push_latest:
        description: "Also push latest tag"
        required: false
        default: true
        type: boolean

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Resolve build variables
        id: vars
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.image }}" ]]; then
            IMAGE="${{ github.event.inputs.image }}"
          else
            IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/blueprint-validation"
          fi

          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.dockerfile }}" ]]; then
            DOCKERFILE="${{ github.event.inputs.dockerfile }}"
          else
            DOCKERFILE="docker/runpod.Dockerfile"
          fi

          SHORT_SHA="${GITHUB_SHA::7}"
          DATE_TAG="$(date -u +%Y%m%d)-${SHORT_SHA}"

          {
            echo "image=${IMAGE}"
            echo "dockerfile=${DOCKERFILE}"
            echo "short_sha=${SHORT_SHA}"
            echo "date_tag=${DATE_TAG}"
          } >> "$GITHUB_OUTPUT"

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute tags
        id: tags
        shell: bash
        run: |
          TAGS=()
          TAGS+=("${{ steps.vars.outputs.image }}:${{ steps.vars.outputs.date_tag }}")
          TAGS+=("${{ steps.vars.outputs.image }}:sha-${{ steps.vars.outputs.short_sha }}")

          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.event.inputs.push_latest }}" == "true" ]]; then
            TAGS+=("${{ steps.vars.outputs.image }}:latest")
          fi

          {
            echo "value<<EOF"
            printf '%s\n' "${TAGS[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ steps.vars.outputs.dockerfile }}
          platforms: linux/amd64
          push: true
          tags: ${{ steps.tags.outputs.value }}
          provenance: false
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        shell: bash
        run: |
          {
            echo "## Docker Publish"
            echo "- Image: \`${{ steps.vars.outputs.image }}\`"
            echo "- Dockerfile: \`${{ steps.vars.outputs.dockerfile }}\`"
            echo "- Tags:"
            echo "\`${{ steps.tags.outputs.value }}\`"
          } >> "$GITHUB_STEP_SUMMARY"
